<!DOCTYPE html>
<html lang="fr">
  <meta charset="utf-8" />
  <title>Utilisateurs • Port</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="/app.js"></script>
  <body onload="requireAuth(); loadUsers();">
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="catways.html">CatWays</a>
      <a href="reservations.html">Réservations</a>
      <a href="users.html">Utilisateurs</a>
      <a href="/api-docs" target="_blank">Doc API</a>
      <div class="right">
        <button onclick="doLogout()">Se déconnecter</button>
      </div>
    </nav>

    <div class="container">
      <h2>Utilisateurs</h2>

      <form id="fCreate">
        <input id="email" type="email" placeholder="Email" required />
        <input id="name" placeholder="Nom" required />
        <input
          id="password"
          type="password"
          placeholder="Mot de passe"
          required
        />
        <button>Créer</button>
        <span id="err" class="err" style="display: none"></span>
      </form>

      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Nom</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr>
            <td colspan="3">Chargement…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script src="app.js"></script>
    <script>
      async function loadUsers() {
        const tb = document.getElementById("tbody");
        tb.innerHTML = "";
        const rows = await http("/users");
        if (rows.length === 0) {
          tb.innerHTML = '<tr><td colspan="3">Aucun</td></tr>';
          return;
        }
        for (const u of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${u.email}</td>
          <td>${u.name}</td>
          <td>
            <button data-edit="${encodeURIComponent(u.email)}">Modifier</button>
            <button data-del="${encodeURIComponent(u.email)}">Supprimer</button>
          </td>`;
          tb.appendChild(tr);
        }
        tb.querySelectorAll("[data-del]").forEach((b) => {
          b.onclick = async () => {
            if (confirm("Supprimer ?")) {
              await http("/users/" + b.dataset.del, { method: "DELETE" });
              loadUsers();
            }
          };
        });
        tb.querySelectorAll("[data-edit]").forEach((b) => {
          b.onclick = async () => {
            const row = b.closest("tr").children;
            const newName = prompt("Nouveau nom", row[1].textContent);
            const newPass = prompt(
              "Nouveau mot de passe (laisser vide pour ne pas changer)",
              ""
            );
            if (!newName && !newPass) return;
            const body = {};
            if (newName) body.name = newName;
            if (newPass) body.password = newPass;
            await http("/users/" + b.dataset.edit, { method: "PUT", body });
            loadUsers();
          };
        });
      }

      document.getElementById("fCreate").onsubmit = async (e) => {
        e.preventDefault();
        const err = document.getElementById("err");
        err.style.display = "none";
        try {
          await http("/users", {
            method: "POST",
            body: {
              email: document.getElementById("email").value,
              name: document.getElementById("name").value,
              password: document.getElementById("password").value,
            },
          });
          e.target.reset();
          loadUsers();
        } catch {
          err.textContent = "Création échouée (email déjà utilisé ?)";
          err.style.display = "inline";
        }
      };
    </script>
  </body>
</html>
